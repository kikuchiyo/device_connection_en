# Configuring direct device connections

To connect to the MQTT broker in the EnOS™ cloud, an MQTT client must have a license issued by the EnOS™. In this task, you'll create a license on EnOS™ and specify the MQTT connection settings.

## Procedure

1. Select **Device Connection** to enter the license page.

2. Click **New License**, enter the name, expiration date of the license, number of devices to allow through the license, type of the device, and description information, and click **Confirm** to complete the license creation.   

   .. image:: media/mqtt_add_license.png

3. Click **Manage** to enter the management interface of the license.

4. Click **New Connection**, enter the device name and description and bind the policy.

   .. image:: media/mqtt.png

5. Click **Manage Policies** to enter the policy list, click **Add policy**, enter the policy name, description, and add the topics.

   .. image:: media/mqtt_policy.png

6. Click **Link test** to enter the connection test page. In the link test, your browser will play as a client to subscribe to the messages.

   A published topic needs to have publication permission, and a subscribed topic needs to have subscription permission; if the publication is unresponsive or disconnected, check that the topic defined in the policy is authorized.

7. Set each parameter for MQTT connection and click **Connect** to establish connection between device and broker.

   .. image:: media/mqtt_test_connection.png

   - **Host Name**: Broker service address.
   - **Device Name**: Device name used to establish a connection, i.e. username.
   - **Device Key**: Key generated when a new device is created, used for authentication, i.e. password.
   - **Client ID**: a unique ID for each device. Establishing connections using the same id for different devices can cause other connections to be disconnected. A random string is generated by default for your web browser because the web browser plays as the client in the connection. You can change the client ID as needed.
   - **SSL**: whether to use SSL connection.
   - **Keep Alive**: Connection duration, in seconds, default to 60 seconds, ranging from 0 to 3600.
   - **Clean Session**: whether to clear session records.
   - **Last-Will Retain**: Whether to retain the Last-will message. When selected, the last-will message will be kept and sent to the new subscription message when it is published.
   - **Last-Will Topic**: Last-will topic.
   - **Last-Will Qos**: The level of service used in the publication of a last-will message. 0 means once at most; 1 means once at least; 2 means precisely once.
   - **Last-Will Message**: IoT Hub will automatically issue this last-will message after the network connection is closed.

8. In the **Subscription** section, click **Add New Topic Subscription** to fill in the topic to subscribe to.

9. In the **Publish** section, enter the topic and message to publish, click the **Publish** button to publish the message. You will then receive the published message in the **Message** section.

   Note that if you did not specify to subscribe to a topic in step 8, your published message for a topic will not be shown in the **Message** section.

   .. image:: media/mqtt_publish.png

   Wildcard Description:

   - “/”: Delimiter
   - “#”: Match one or multiple segments separated by delimiters, such as topic/#, which can match: `topic/`, `topic/test`, `topic/test/test`, etc.
   - “+”: Match a single segment separated by delimiters, such as `topic/+/test`, which can match `topic/test/test`, `topic/123/test`, etc.

## Related Information

### Connection Mode of MQTT and its Port Number

- tcp: 11883
- ssl: 18883
- websocket: 11884
- ssl websocket: 18884

## JAVA Instance Code

```
public class MqttPub {
    private static final char[] PASSWD = **cNetty**.toCharArray();
    private static final String ALGORITHM = **SunX509**;
    private static final String jks = **cChat.jks**;

    private static SSLContext createContext() throws Exception {
        SSLContext context = SSLContext.getInstance(**TLS**);
        KeyStore ks = KeyStore.getInstance(**JKS**);

        ks.load(new FileInputStream(new File(jks)), PASSWD);
        TrustManagerFactory tmf = TrustManagerFactory.getInstance(ALGORITHM);
        tmf.init(ks);
        context.init(null, tmf.getTrustManagers(), null);
        return context;
    }

    public static void main(String[] args) throws Exception {
        final String broker = **ssl://eos-beta.envisioncn.com:18883**;

        new Thread() {
            @Override
            public void run() {
                try {
                    SSLContext ctx = createContext();
                    // broker means host name: “paho-java-client-3” means user ID
                    MqttClient sampleClient = new MqttClient(broker, **paho-java-client-3**, new MqttDefaultFilePersistence());
                    MqttConnectOptions connOpts = new MqttConnectOptions();
                    connOpts.setCleanSession(false);
                    // username means device name; password means device key
                    connOpts.setUserName(**GCP_China_01**);
                    connOpts.setPassword(**4ab11cbc99a398b344418228b9ee2d6489e6c2fb**.toCharArray());
                    connOpts.setSocketFactory(ctx.getSocketFactory());

                    sampleClient.connect(connOpts);

                    for (int i = 0; i < 10; i++) {
                        String msg = String
                                .format(**{\**object\**: \**1958f6c92bc00000\**, \**timestamp\**:%d, \**METER3X.UA\**:\**50.0\**, \**DEVICE_CONN\**:\**%d\**}**,
                                        System.currentTimeMillis(), i);
                        MqttMessage message = new MqttMessage(msg.getBytes());
                        message.setQos(1);
                        // message.setRetained(true);
                        sampleClient.publish(**Meter**, message);
                    }
                } catch (Exception me) {
                    me.printStackTrace();
                }
            }

        }.start();

        TimeUnit.SECONDS.sleep(2);
    }
}
```

The example code is based on an open source paho mqtt client, and the corresponding Maven dependency is

```
<dependency>
    <groupId>org.eclipse.paho</groupId>
    <artifactId>org.eclipse.paho.client.mqttv3</artifactId>
    <version>1.0.2</version>
</dependency>
```


<!--end-->
